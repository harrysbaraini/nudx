minio.pkg = pkgs.minio;

minio.scripts.on_start = pkgs.writeShellScript "minio_on_start_hook" ''
  {{#each options.buckets as | bucket |}}
  if [[ ! -d "{{../dataDir}}/{{bucket}}" ]]; then
    mkdir -p {{../dataDir}}/{{bucket}}
  fi
  {{/each}}
'';

minio.scripts.run = pkgs.writeShellScript "minio_run" ''
  exec ${minio.pkg}/bin/minio server --address {{address}} {{dataDir}}
'';

services.minio = {
  packages = [ minio.pkg ];

  processes = [
    {
      name = "minio";
      script = "${minio.scripts.run}";
      on_start = "${minio.scripts.on_start}";
    }
  ];
};

php.pkg = phpShell.packages.${system}.{{phpPkg}};

php.files.phpIni = pkgs.writeText "php.ini" ''
  memory_limit=1G
'';

php.files.fpmConfig = pkgs.writeText "php-fpm.conf" ''
  [global]
  pid={{fpm.pidFile}}
  error_log={{site.statePath}}/php-fpm.log
  emergency_restart_threshold=10
  emergency_restart_interval=1m
  process_control_timeout=10s

  [web]
  pm=dynamic
  pm.max_children=2
  pm.start_servers=1
  pm.min_spare_servers=1
  pm.max_spare_servers=1
  pm.max_requests=100
  listen={{fpm.socketFile}}
'';

services.php = {
  packages = [
    php.pkg
    pkgs.phpPackages.composer
    {{#each extensions as | ext |}}
    pkgs.{{../phpPkg}}Extensions.{{ext}}
    {{/each}}
  ];

  scripts = php.scripts;

  env = [
    { name = "PHP_PATH"; value = "${php.pkg}/bin/php"; }
  ];

  processes = [
    {
      name = "{{site.id}}-phpfpm";
      value = {
        command = "${php.pkg}/bin/php-fpm -F -y ${php.files.fpmConfig} -c ${php.files.phpIni}";
      };
    }
  ];
};

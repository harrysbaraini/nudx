if [[ ! -d "{{HOME}}" || ! -f "{{HOME}}/ibdata1" ]]; then
    echo "Creating MySQL Data Directory..."
    mkdir -p {{HOME}}
    {{pkgName}}/bin/mysqld {{{CMD_FLAGS}}} --default-time-zone=SYSTEM --initialize-insecure
fi

# Create initial databases
{{#config.databases as | db |}}
if ! test -e "{{HOME}}/{{db.name}}"; then
    echo "Creating initial database: {{db.name}}"
    ( echo 'create database \`{{db.name}}\`;'
      {{#if db.schema}}
        echo 'use \`{{db.name}}\`;'
        if [ -f "{{db.schema}}" ]
        then
            cat {{db.schema}}
        elif [ -d "{{db.schema}}" ]
        then
            cat {{db.schema}}/*.sql
        fi
      {{/if}}
    ) | {{../pkgName}}/bin/mysql -u {{../superUser}} --socket {{../UNIX_PORT}} -N
fi
{{/config.databases}}

# Ensure a user exists because we don't want to run this service as 'root'
(echo "CREATE USER IF NOT EXISTS '{{config.user}}'@'localhost' IDENTIFIED WITH "auth_socket"};"
    echo "GRANT ALL PRIVILEGES ON *.* TO '{{config.user}}'@'localhost' WITH GRANT OPTION;"
) | {{pkgName}}/bin/mysql -u {{superUser}} -N

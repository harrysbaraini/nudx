redis.pkg = pkgs.redis;
redis.dataDir = "{{site.statePath}}/redis";
redis.socketFile = "{{site.statePath}}/redis.sock";

redis.configFile = pkgs.writeText "redis.conf" ''
  port 0
  unixsocket ${redis.socketFile}
  unixsocketperm 700
  dir ${redis.dataDir}
'';

redis.scripts.on_start = pkgs.writeShellScript "redis_on_start" ''
  if [[ ! -d "${redis.dataDir}" ]]; then
    mkdir -p "${redis.dataDir}"
  fi
'';

redis.scripts.run = pkgs.writeShellScript "redis_run" ''
  exec ${redis.pkg}/bin/redis-server ${redis.configFile}
'';

services.redis = {
  packages = [ redis.pkg ];

  processes = [
    {
      name = "redis";
      script = "${redis.scripts.run}";
      on_start = "${redis.scripts.on_start}";
    }
  ];
};

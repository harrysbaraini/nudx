export NUDX_ES_PORT=$(cat {{esPortFile}} | head -n 1)

if [[ ! -d "{{ES_HOME}}" ]]; then
  mkdir -m 0700 -p {{ES_HOME}}

  # elasticsearch needs to create the elasticsearch.keystore in the config directory
  # so this directory needs to be writable.
  mkdir -m 0700 -p {{ES_PATH_CONF}}

  # Make sure the logging configuration for old elasticsearch versions is removed:
  rm -f "{{ES_PATH_CONF}}/logging.yml"
  cp ${loggingConfigFile} {{ES_PATH_CONF}}/{{loggingConfigFile}}

  mkdir -p {{ES_PATH_CONF}}/scripts
  mkdir -p {{ES_HOME}}/plugins
  ln -sfT {{pkgName}}/lib {{ES_HOME}}/lib
  ln -sfT {{pkgName}}/modules {{ES_HOME}}/modules
  cp {{pkgName}}/config/jvm.options {{ES_PATH_CONF}}/jvm.options

  # redirect jvm logs to the data directory
  mkdir -m 0700 -p {{ES_HOME}}/logs
  ${pkgs.sd}/bin/sd 'logs/gc.log' '{{ES_HOME}}/logs/gc.log' {{ES_PATH_CONF}}/jvm.options
fi

if [[ -f "{{ES_PATH_CONF}}/elasticsearch.yml" ]]; then
  rm -f {{ES_PATH_CONF}}/elasticsearch.yml
fi

# Note that we copy config files from the nix store instead of symbolically linking them
# because otherwise X-Pack Security will raise the following exception:
# java.security.AccessControlException:
# access denied ("java.io.FilePermission" "/var/lib/elasticsearch/config/elasticsearch.yml" "read")
echo "{{esConfigBase}}" > {{ES_PATH_CONF}}/elasticsearch.yml
